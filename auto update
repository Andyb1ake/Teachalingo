name: Auto Generate Teachalingo Content

on:
  schedule:
    # Every 1st of the month at 00:00 UTC → new 250-unit section for Math & Science
    - cron: '0 0 1 * *'
    # Every 10 days at 00:00 UTC → 300 new role-play scenarios
    - cron: '0 0 */10 * *'
  workflow_dispatch:  # Lets you manually trigger it for testing

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install axios groq-sdk

      - name: Run AI generator
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: node scripts/auto-generate.js

      - name: Commit & push new content
        run: |
          git config --global user.name "Auto AI Updater"
          git config --global user.email "ai@teachalingo.com"
          git add public/data/
          git commit -m "Auto AI update: $(date +'%Y-%m-%d')" || echo "No changes to commit"
          git push// scripts/auto-generate.js
const fs = require('fs');
const path = require('path');
const { Groq } = require('groq-sdk');

const groq = new Groq({ apiKey: process.env.GROQ_API_KEY });

async function generateContent(prompt) {
  const completion = await groq.chat.completions.create({
    messages: [{ role: 'user', content: prompt }],
    model: 'llama-3.1-8b-instant', // fast & cheap
  });
  return completion.choices[0]?.message?.content || '{}';
}

async function addNewSection(course) {
  const prompt = `Generate exactly 250 new units for the ${course} course in JSON format only.
  Structure:
  {
    "sectionId": number,
    "units": [
      {
        "unitId": number,
        "title": "string",
        "description": "string",
        "lessonCircles": array of objects (12 for Math, 15 for Science),
        "each lessonCircle": { "lessons": array of 6-8 objects, each with 15 questions }
      }
    ]
  }
  Make content progressively harder, adult-level by end. Return ONLY valid JSON.`;

  const result = await generateContent(prompt);
  let newSection;
  try {
    newSection = JSON.parse(result);
  } catch (e) {
    console.error('JSON parse failed', e);
    return;
  }

  const filePath = path.join(__dirname, `../public/data/${course}.json`);
  let existing = { sections: [] };
  if (fs.existsSync(filePath)) {
    existing = JSON.parse(fs.readFileSync(filePath, 'utf8'));
  }

  existing.sections.push(newSection);
  fs.writeFileSync(filePath, JSON.stringify(existing, null, 2));
  console.log(`Added new 250-unit section to ${course}`);
}

async function addRolePlays() {
  const prompt = `Generate exactly 300 new role-play scenarios in JSON format.
  Return ONLY: { "scenarios": [ { "id": number, "title": "string", "description": "string", "category": "string" } ] }
  Themes: daily life, food, travel, work, health, etc.`;

  const result = await generateContent(prompt);
  let newScenarios;
  try {
    newScenarios = JSON.parse(result);
  } catch (e) {
    console.error('Role-play parse failed', e);
    return;
  }

  const filePath = path.join(__dirname, '../public/data/roleplays.json');
  let existing = { scenarios: [] };
  if (fs.existsSync(filePath)) {
    existing = JSON.parse(fs.readFileSync(filePath, 'utf8'));
  }

  existing.scenarios.push(...newScenarios.scenarios);
  fs.writeFileSync(filePath, JSON.stringify(existing, null, 2));
  console.log('Added 300 new role-plays');
}

// Decide what to run based on schedule
const isMonthly = new Date().getDate() === 1;
const isTenDay = new Date().getDate() % 10 === 0;

if (isMonthly) {
  addNewSection('math');
  addNewSection('science');
}
if (isTenDay) {
  addRolePlays();
}
